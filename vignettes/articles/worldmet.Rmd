---
title: "Using {worldmet} to Locate, Import & Visualise Meteorological Data"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(worldmet)
```

# Importing Hourly Meteorological Data

## Show all sites

The function to use to find which sites are available is `import_ghcn_stations()`.

```{r getmeta}
import_ghcn_stations()
```

A better way to explore available stations is by using `return = "map"`, which shows each station on an interactive map. Click to expand the markers until you find the site of interest (shown by a blue marker), which can then be clicked for further information. The most important information revealed in the marker is the station ID, which is used to access the data.

```{r getmeta_map, out.width="100%"}
import_ghcn_stations(return = "map")
```

## Search based on latitude and longitude

Often, one has an idea of the region in which a site is of interest. For example, if the interest was in sites close to London, the latitude and longitude can be supplied and a search is carried out of the 10 nearest sites to that location. There is also an option n that can be used in change the number of nearest sites shown. If a lat/lng is provided, clicking on the blue marker will show the approximate distance between the site and the search coordinates.

```{r searchmeta, out.width="100%"}
import_ghcn_stations(lat = 51.5, lng = 0, return = "map")
```

## Importing Data

To obtain the data the user must supply a station ID and year(s) of interest. For example, to download data for Heathrow Airport in 2024 (ID `UKI0000EGLL`):

```{r import, eval=FALSE, echo=TRUE}
met_london <- import_ghcn_hourly("UKI0000EGLL", year = 2025)
head(met_london)
```

```{r importtrue, eval=TRUE, echo=FALSE}
load("met_london.RData")
head(met_london)
```

A wind rose (for example) can easily be plotted using `openair`:

```{r windrose}
# use function from openair
openair::windRose(met_london)
```

# Data Types

`worldmet` can access data from the newer Global Historic Climate Network (GHCN) and the legacy Integrated Surface Database (ISD). The ISD can be accessed using:

- `import_isd_stations()` to obtain metadata, and

- `import_isd_hourly()` and `import_isd_lite()` to obtain measurement data.

The GHCN contains other products outside of hourly data. Also available in `worldmet` are:

- `import_ghcn_daily()`, which imports daily average data. Users may select specific stations, but all available years for that station will be downloaded.

- `import_ghcn_monthly_temp()`, which imports monthly average temperatures for the entire GHCN.

- `import_ghcn_monthly_prcp()`, which imports monthly total precipitation for specific stations.

# Parallel Processing

If you are importing a lot of meteorological data, this can take a long while. This is because each combination of year and station (for hourly data) requires downloading a separate data file from NOAA's online data directory, and the time each download takes can quickly add up. Many functions in `worldmet` can use parallel processing to speed downloading up, powered by the capable `{mirai}` package. If users have any `{mirai}` "daemons" set, certain files will be downloaded in parallel. The greatest benefits will be seen if you spawn as many daemons as you have cores on your machine, although one fewer than the available cores is often a good rule of thumb. Your mileage may vary, however, and naturally spawning more daemons than station-year combinations will lead to diminishing returns.

```r
# set workers - once per session
mirai::daemons(4)

# import lots of data - NB: no change in import_ghcn_hourly()!
big_met <- import_ghcn_hourly(code = "UKI0000EGLL", year = 2010:2025)
```

The following functions support `{mirai}`-powered parallelism.

- `import_ghcn_hourly()`

- `import_ghcn_daily()`

- `import_ghcn_monthly_prcp()` (but **not** `import_ghcn_monthly_temp()`)

- `import_isd_hourly()`

- `import_isd_lite()`

> Historically, parallelism in `{worldmet}` was achieved with `{doParallel}`, `{foreach}` and `{parallel}` and was activated using the `n.cores` argument of the legacy `importNOAA()` function. While this will still work, it is recommended users set their own daemons before using `importNOAA()`. This should avoid any issues with mistakenly spawning too many daemons, or accidentally spawning daemons within other daemons.
